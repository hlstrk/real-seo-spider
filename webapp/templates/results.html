{% extends "base.html" %}
{% set title = "Sonuçlar" %}

{% block content %}
  <div class="row g-3">
    <aside class="col-12 col-lg-3">
      <div class="card shadow-sm mt-0">
        <div class="card-header">
          <div class="card-title h6 mb-0">Önceki Taramalar</div>
          <div class="text-muted small">URL ve zaman</div>
        </div>
        <div class="card-body">
          {% if not jobs %}
            <p class="text-muted mb-0">Henüz tarama yok.</p>
          {% else %}
            <div class="list-group list-group-flush">
              {% for j in jobs %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div class="text-truncate" style="max-width:70%;">
                    <a href="/results/{{ j.id }}" class="fw-semibold text-decoration-none">{{ (j.params.get("start_url") or "")|truncate(80, True, "…") }}</a>
                    <div class="text-muted small">{{ j.created_at|fmt_dt }}</div>
                  </div>
                  <span class="badge bg-secondary text-uppercase">{{ j.status }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </aside>

    <main class="col-12 col-lg-9">
      {% if not job %}
        <div class="card shadow-sm mb-3">
          <h2>Job bulunamadı</h2>
          <p>Bu ID ile bir tarama yok: <code>{{ job_id }}</code></p>
          <a class="btn" href="/">Yeni tarama</a>
        </div>
      {% else %}
        {% if job.status == "done" %}
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="row align-items-center g-3">
              <div class="col">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <h3 class="h5 mb-0">Güvenlik Başlıkları (HSTS vb.)</h3>
                  <span class="badge text-bg-info">Beta</span>
                </div>
                <p class="text-muted mb-2 small">Strict-Transport-Security, CSP, X-Content-Type-Options, Referrer-Policy, Permissions-Policy, X-Frame-Options.</p>
                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#secModal">Detayları Gör</button>
              </div>
              <div class="col-auto">
                <div style="width:160px; height:160px;">
                  <canvas id="secPie"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="row row--tight mb-3">
              <div>
                <h3 class="h5 mb-1">Denetim Kapsamı</h3>
                <div class="text-muted small">Bu taramada kontrol edilen başlıkların özeti (en az yarısı etkin).</div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="Sitemap & robots.txt; URL keşfi; iç link toplama ve normalize etme">
                      <b>Sitemap & robots.txt</b> okuma + URL keşfi
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="HTTP 2xx/3xx/4xx/5xx, redirect chain/loop ve content-type kontrolü">
                      <b>HTTP durumları</b> 2xx/3xx/4xx/5xx, redirect zinciri
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="Meta robots, X-Robots-Tag ve canonical doğrulaması">
                      <b>Indexlenebilirlik</b> meta robots / X-Robots / canonical
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="Title/meta description uzunluk, boşluk, kopya tespiti">
                      <b>Meta etiketler</b> title / description (boş, uzun, kopya)
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="H1 var mı/tek mi ve heading hiyerarşisi">
                      <b>Heading yapısı</b> H1 var/tek mi, hiyerarşi
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="HTML lang ve hreflang var mı, dil eşleşmeleri (temel kontrol)">
                      <b>Hreflang / html lang</b> (çok dilliler için)
                    </button>
                    <span class="badge text-bg-secondary">Kısmi</span>
                  </li>
                </ul>
              </div>
              <div class="col-md-6">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="Schema / JSON-LD var mı, parse hatası ve zorunlu alanlar (özet)">
                      <b>Schema / JSON-LD</b> var mı, parse hatası
                    </button>
                    <span class="badge text-bg-secondary">Kısmi</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="og:title/description/image ve Twitter Card temel alanları">
                      <b>Open Graph / Twitter</b> temel alanlar
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="Alt text, kırık görsel, format/weight (webp/avif), lazy-load/LCP">
                      <b>Görsel SEO</b> alt text, kırık görsel, format/weight, lazy-load
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="Thin content, duplicate/near-duplicate için özet kontrol">
                      <b>İçerik kalite</b> thin / near-duplicate (özet)
                    </button>
                    <span class="badge text-bg-secondary">Kısmi</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="Render-blocking kaynaklar ve temel CWV sinyalleri (LCP/CLS/INP özet)">
                      <b>Performans</b> render-blocking / temel CWV sinyalleri
                    </button>
                    <span class="badge text-bg-secondary">Kısmi</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <button class="btn btn-link p-0 text-start" data-coverage-detail="HSTS, CSP, cache-control, compression; HSTS/PHPN header eksikleri ve http assetler modalda listelenir">
                      <b>Güvenlik başlıkları</b> HSTS, CSP, cache-control, compression
                    </button>
                    <span class="badge text-bg-success">Aktif</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="row row--tight mb-3">
              <div>
                <h2>Genel Özet</h2>
                <div class="muted">Bu tarama için hızlı özet + SEO tool tarzı şemalar.</div>
              </div>
            </div>

            <div class="row g-3 text-center align-items-start">
              <div class="col-6 col-md-4 col-lg-2">
                <div class="chart chart--mini">
                  <div class="chart__title">SEO Skoru</div>
                  <svg class="chart__svg" id="scoreDonut" viewBox="0 0 120 120" aria-label="SEO skoru donut"></svg>
                  <div class="chart__value"><b>{{ seo_score }}%</b></div>
                </div>
              </div>
              <div class="col-6 col-md-4 col-lg-2">
                <div class="chart chart--mini">
                  <div class="chart__title">Meta</div>
                  <svg class="chart__svg" id="metaDonut" viewBox="0 0 120 120" aria-label="Meta donut"></svg>
                  <div class="chart__value"><b id="metaVal">-</b></div>
                </div>
              </div>
              <div class="col-6 col-md-4 col-lg-2">
                <div class="chart chart--mini">
                  <div class="chart__title">Başlıklar</div>
                  <svg class="chart__svg" id="headersDonut" viewBox="0 0 120 120" aria-label="Headers donut"></svg>
                  <div class="chart__value"><b id="headersVal">-</b></div>
                </div>
              </div>
              <div class="col-6 col-md-4 col-lg-2">
                <div class="chart chart--mini">
                  <div class="chart__title">Görseller</div>
                  <svg class="chart__svg" id="imagesDonut" viewBox="0 0 120 120" aria-label="Images donut"></svg>
                  <div class="chart__value"><b id="imagesVal">-</b></div>
                </div>
              </div>
              <div class="col-6 col-md-4 col-lg-2">
                <div class="chart chart--mini">
                  <div class="chart__title">Performans</div>
                  <svg class="chart__svg" id="perfDonut" viewBox="0 0 120 120" aria-label="Performance donut"></svg>
                  <div class="chart__value"><b id="perfVal">-</b></div>
                </div>
              </div>
              <div class="col-6 col-md-4 col-lg-2">
                <div class="chart">
                  <div class="chart__title">Sorun Dağılımı</div>
                  <svg class="chart__svg" id="issuesPie" viewBox="0 0 120 120" width="120" height="120" aria-label="Issue pie"></svg>
                  <div class="chart__legend mx-auto" id="issuesLegend"></div>
                </div>
              </div>
            </div>

            {% if site_summary %}
              <p class="summary mb-0">{{ site_summary }}</p>
            {% endif %}
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center gap-3">
              <div class="flex-grow-1">
                <h2 class="h5 mb-1">Sonuçlar</h2>
                <div class="text-muted small">Tarama ID: <code>{{ job_id }}</code> · Başlangıç: <code>{{ job.params.get("start_url") }}</code></div>
                <div class="mt-2">
                  <span class="badge bg-{% if job.status == 'done' %}success{% elif job.status == 'error' %}danger{% else %}warning{% endif %}">{{ TR.status.get(job.status, job.status) }}</span>
                  {% if job.status in ["queued","running"] %}
                    <span class="text-muted small">Tarama devam ediyor; bu sayfa otomatik yenilenir.</span>
                    <div class="progress mt-2" style="height:10px;">
                      <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 60%" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% endif %}
                  {% if job.status == "error" %}
                    <div class="text-danger small mt-1">Hata: {{ job.error }}</div>
                  {% endif %}
                  {% if job.status == "done" %}
                    <div class="progress mt-2" style="height:10px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  {% endif %}
                </div>
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-outline-primary btn-sm" href="/download/{{ job_id }}/issues.csv">CSV indir</a>
                <a class="btn btn-outline-primary btn-sm" href="/download/{{ job_id }}/report.json">JSON indir</a>
              </div>
            </div>
          </div>
        </div>

          {% if job.status == "done" %}
          <div class="card shadow-sm mb-3">
            <div class="card-body">
            <div class="row row--tight">
              <h3 style="margin:0">Checklist</h3>
              <div class="spacer"></div>
              <button class="btn btn-outline-secondary btn-sm" type="button" id="clearChecks">Tümünü sıfırla</button>
            </div>

            {% if issues_count == 0 %}
              <p>Issue bulunamadı.</p>
            {% else %}
              <div class="checks checklist" data-job="{{ job_id }}" id="checksWrap">
                {% for it in job.issues %}
                  {% set ev = (it.evidence or "") %}
                  {% set thumb = "" %}
                  {% if it.field and it.field.startswith("img_") and (ev.startswith("http://") or ev.startswith("https://")) %}
                    {% set thumb = ev.split(" | ")[0] %}
                  {% endif %}
                  {% set thumb_base = thumb.split("?")[0].split("#")[0].lower() %}
                  {% set is_thumb_ok = thumb and (thumb_base.endswith(".jpg") or thumb_base.endswith(".jpeg") or thumb_base.endswith(".png") or thumb_base.endswith(".webp") or thumb_base.endswith(".avif") or thumb_base.endswith(".gif") or thumb_base.endswith(".svg")) %}
                  {% set sev = (it.severity or "").lower() %}
                  {% set sev_class = "badge text-bg-secondary" %}
                  {% if sev == "medium" %}{% set sev_class = "badge bg-warning text-dark" %}{% elif sev == "high" %}{% set sev_class = "badge bg-danger" %}{% endif %}
                  <label class="check check-item d-flex gap-3 align-items-start" data-category="{{ it.category }}">
                    <input class="form-check-input mt-1" type="checkbox" data-k="{{ loop.index0 }}" />
                    {% if is_thumb_ok %}
                      <img class="check-thumb" src="{{ thumb }}" alt="thumbnail" loading="lazy" />
                    {% endif %}
                    <div class="flex-grow-1 d-flex flex-column gap-2">
                      <div class="d-flex align-items-center gap-2 mb-1">
                        <span class="{{ sev_class }}">{{ TR.severity.get(it.severity, it.severity) }}</span>
                        <span class="text-muted small">{{ TR.field.get(it.field, it.field) }}</span>
                      </div>
                      <div class="fw-semibold">{{ it.message }}</div>
                      <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                        <div class="check-meta">
                          <code>{{ it.category }}</code> • <code>{{ TR.issue_type.get(it.issue_type, it.issue_type) }}</code> •
                          <a href="{{ it.url }}" target="_blank" rel="noreferrer">{{ it.url }}</a>
                          {% if it.suggestion %} • <span class="text-muted">{{ it.suggestion }}</span>{% endif %}
                          {% if it.evidence %}
                            •
                            {% if it.evidence.startswith("http://") or it.evidence.startswith("https://") %}
                              <a href="{{ it.evidence }}" target="_blank" rel="noreferrer">{{ it.evidence|truncate(70, True, "…") }}</a>
                            {% elif it.evidence.startswith("data:") or it.evidence.startswith("data://") %}
                              <span class="text-muted">inline veri ({{ it.evidence|length }} karakter)</span>
                            {% else %}
                              <span class="text-muted">{{ it.evidence|truncate(80, True, "…") }}</span>
                            {% endif %}
                          {% endif %}
                        </div>
                        <a class="mini-link mini-link--full ms-auto" href="/issue/{{ job_id }}/{{ loop.index0 }}">➜ Sorunu gör</a>
                      </div>
                    </div>
                  </label>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h3>Sayfa Detayları</h3>
              <div class="accordion accordion-flush mt-3" id="pagesAccordion">
                {% for p in job.pages %}
                  {% set collapse_id = "page-" ~ loop.index0 %}
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ collapse_id }}">
                      <button class="accordion-button {% if loop.index0 != 0 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}" aria-expanded="{{ 'true' if loop.index0 == 0 else 'false' }}" aria-controls="{{ collapse_id }}">
                        <span class="text-truncate">{{ p.final_url or p.url }}</span>
                        <span class="badge bg-secondary ms-2">{{ p.status_code }}</span>
                        {% if p.html_lang %}<span class="badge bg-light text-muted ms-2">{{ p.html_lang }}</span>{% endif %}
                      </button>
                    </h2>
                    <div id="{{ collapse_id }}" class="accordion-collapse collapse {% if loop.index0 == 0 %}show{% endif %}" aria-labelledby="heading-{{ collapse_id }}" data-bs-parent="#pagesAccordion">
                      <div class="accordion-body">
                        {% set purl = p.final_url or p.url %}
                        {% if page_summaries and page_summaries.get(purl) %}
                          <div class="page-summary mb-3">
                            <div class="page-summary__title">Bu sayfanın genel sorunu</div>
                            <div class="page-summary__text">{{ page_summaries.get(purl) }}</div>
                          </div>
                        {% endif %}
                        <div class="table-responsive mb-3">
                          <table class="table table-sm align-middle mb-0">
                            <tbody>
                              <tr><th style="width:140px">Title</th><td>{{ p.title or "-" }}</td></tr>
                              <tr><th>Meta desc</th><td>{{ p.meta_description or "-" }}</td></tr>
                              <tr><th>H1</th><td>{{ p.h1 or "-" }}</td></tr>
                              <tr><th>Canonical</th><td>{% if p.canonical %}<a href="{{ p.canonical }}" target="_blank" rel="noreferrer">{{ p.canonical }}</a>{% else %}-{% endif %}</td></tr>
                              <tr><th>HSTS</th><td>{% if p.hsts %}<code>{{ p.hsts }}</code>{% else %}<span class="muted">yok</span>{% endif %}</td></tr>
                            </tbody>
                          </table>
                        </div>

                        <div class="subhead">Görseller</div>
                        {% if not p.images %}
                          <div class="muted">Görsel bulunamadı.</div>
                        {% else %}
                          <div class="table-responsive">
                            <table class="table table-sm table-striped align-middle mb-0">
                              <thead class="table-light">
                                <tr>
                                  <th style="width:120px">Alaka</th>
                                  <th style="width:180px">Alt</th>
                                  <th style="width:200px">Dosya Adı</th>
                                  <th>Kaynak</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for im in p.images %}
                                <tr class="{% if not im.alt %}row-warn{% endif %}">
                                  <td>
                                    {% set rel = (image_relevance.get(purl, {}) if image_relevance else {}) %}
                                    {% set score = rel.get(im.src) %}
                                    {% if score is number %}
                                      <span class="pill pill--muted" title="OpenAI skoru (0-100)">{{ score }}%</span>
                                    {% else %}
                                      <span class="text-muted">-</span>
                                    {% endif %}
                                  </td>
                                  <td>{% if im.alt %}{{ im.alt }}{% else %}<span class="text-muted">Eksik</span>{% endif %}</td>
                                  <td><code>{{ im.filename or "-" }}</code></td>
                                  <td class="url">
                                    {% if im.src.startswith("data:") or im.src.startswith("data://") %}
                                      <span class="text-muted">inline veri ({{ im.src|length }} karakter)</span>
                                    {% else %}
                                      <a href="{{ im.src }}" target="_blank" rel="noreferrer" title="{{ im.src }}">{{ im.src|truncate(90, True, "…") }}</a>
                                    {% endif %}
                                  </td>
                                </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endif %}
    </main>

  </div>

  <script>
    (function () {
      // Charts
      const score = Number({{ seo_score|default(0) }}) || 0;
      const sevCounts = {{ severity_counts|tojson }};
      const donuts = {{ donuts|tojson }};

      function polarToCartesian(cx, cy, r, angleDeg) {
        const a = (angleDeg - 90) * Math.PI / 180.0;
        return { x: cx + (r * Math.cos(a)), y: cy + (r * Math.sin(a)) };
      }
      function arcPath(cx, cy, r, startAngle, endAngle) {
        const start = polarToCartesian(cx, cy, r, endAngle);
        const end = polarToCartesian(cx, cy, r, startAngle);
        const largeArc = (endAngle - startAngle) <= 180 ? "0" : "1";
        return `M ${start.x} ${start.y} A ${r} ${r} 0 ${largeArc} 0 ${end.x} ${end.y}`;
      }

      function renderDonut(svg, value) {
        if (!svg) return;
        svg.innerHTML = "";
        const style = getComputedStyle(document.documentElement);
        const c1 = (style.getPropertyValue("--accent") || "#4f46e5").trim();
        const c2 = (style.getPropertyValue("--accent2") || "#06b6d4").trim();
        const cx = 60, cy = 60, r = 44, w = 12;
        const base = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        base.setAttribute("cx", String(cx));
        base.setAttribute("cy", String(cy));
        base.setAttribute("r", String(r));
        base.setAttribute("fill", "none");
        base.setAttribute("stroke", "rgba(255,255,255,.18)");
        base.setAttribute("stroke-width", String(w));
        svg.appendChild(base);

        const arc = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const end = Math.max(0, Math.min(100, value)) / 100 * 360;
        arc.setAttribute("d", arcPath(cx, cy, r, 0, end));
        arc.setAttribute("fill", "none");
        arc.setAttribute("stroke", "url(#gradScore)");
        arc.setAttribute("stroke-width", String(w));
        arc.setAttribute("stroke-linecap", "round");

        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const grad = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
        grad.setAttribute("id", "gradScore");
        grad.setAttribute("x1", "0%"); grad.setAttribute("y1", "0%");
        grad.setAttribute("x2", "100%"); grad.setAttribute("y2", "100%");
        const s1 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
        s1.setAttribute("offset", "0%");
        s1.setAttribute("stop-color", c1);
        const s2 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
        s2.setAttribute("offset", "100%");
        s2.setAttribute("stop-color", c2);
        grad.appendChild(s1); grad.appendChild(s2);
        defs.appendChild(grad);
        svg.appendChild(defs);
        svg.appendChild(arc);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", String(cx));
        text.setAttribute("y", String(cy + 6));
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("font-size", "18");
        text.setAttribute("font-weight", "900");
        text.setAttribute("fill", "currentColor");
        text.textContent = `${Math.round(value)}%`;
        svg.appendChild(text);
      }

      function renderPie(svg, legend, data) {
        if (!svg) return;
        svg.innerHTML = "";
        if (legend) legend.innerHTML = "";
        const cx = 60, cy = 60, r = 50;
        const total = Object.values(data).reduce((a,b) => a + (Number(b)||0), 0) || 0;
        if (!total) {
          const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
          t.setAttribute("x", String(cx));
          t.setAttribute("y", String(cy));
          t.setAttribute("text-anchor", "middle");
          t.setAttribute("font-size", "12");
          t.setAttribute("fill", "currentColor");
          t.textContent = "0";
          svg.appendChild(t);
          return;
        }
        const palette = {
          high: "rgba(255,85,120,.9)",
          medium: "rgba(255,194,69,.9)",
          low: "rgba(54,211,153,.9)"
        };
        let start = 0;
        for (const k of ["high","medium","low"]) {
          const v = Number(data[k] || 0);
          if (!v) continue;
          const angle = (v / total) * 360;
          const end = start + angle;
          const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
          const a0 = polarToCartesian(cx, cy, r, end);
          const a1 = polarToCartesian(cx, cy, r, start);
          const large = angle > 180 ? 1 : 0;
          const d = [
            `M ${cx} ${cy}`,
            `L ${a1.x} ${a1.y}`,
            `A ${r} ${r} 0 ${large} 1 ${a0.x} ${a0.y}`,
            "Z"
          ].join(" ");
          p.setAttribute("d", d);
          p.setAttribute("fill", palette[k] || "rgba(255,255,255,.3)");
          svg.appendChild(p);
          if (legend) {
            const item = document.createElement("div");
            item.className = "legend-item";
            item.innerHTML = `<span class="dot" style="background:${palette[k] || "#999"}"></span><span>${k}: ${v}</span>`;
            legend.appendChild(item);
          }
          start = end;
        }
      }

      renderDonut(document.getElementById("scoreDonut"), score);
      renderDonut(document.getElementById("metaDonut"), Number(donuts.meta||0));
      renderDonut(document.getElementById("headersDonut"), Number(donuts.headers||0));
      renderDonut(document.getElementById("imagesDonut"), Number(donuts.images||0));
      renderDonut(document.getElementById("perfDonut"), Number(donuts.performance||0));
      const mv = document.getElementById("metaVal"); if (mv) mv.textContent = `${Math.round(Number(donuts.meta||0))}%`;
      const hv = document.getElementById("headersVal"); if (hv) hv.textContent = `${Math.round(Number(donuts.headers||0))}%`;
      const iv = document.getElementById("imagesVal"); if (iv) iv.textContent = `${Math.round(Number(donuts.images||0))}%`;
      const pv = document.getElementById("perfVal"); if (pv) pv.textContent = `${Math.round(Number(donuts.performance||0))}%`;
      renderPie(document.getElementById("issuesPie"), document.getElementById("issuesLegend"), sevCounts);

      // Category filtering
      const list = document.getElementById("catList");
      const wrapChecks = document.getElementById("checksWrap");
      function setActive(cat) {
        if (!list) return;
        for (const b of list.querySelectorAll(".cat")) {
          b.classList.toggle("cat--active", b.getAttribute("data-cat") === cat);
        }
      }
      function applyFilter(cat) {
        if (!wrapChecks) return;
        for (const row of wrapChecks.querySelectorAll(".check[data-category]")) {
          const c = row.getAttribute("data-category") || "general";
          const show = cat === "__all__" || c === cat;
          row.style.display = show ? "" : "none";
        }
      }
      if (list && wrapChecks) {
        list.addEventListener("click", (e) => {
          const btn = e.target.closest(".cat");
          if (!btn) return;
          const cat = btn.getAttribute("data-cat") || "__all__";
          setActive(cat);
          applyFilter(cat);
        });
      }

      // Checklist state
      const wrap = document.querySelector(".checks");
      if (!wrap) return;
      const jobId = wrap.getAttribute("data-job");
      const storageKey = "rss_checks_" + jobId;
      const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");

      for (const input of wrap.querySelectorAll("input[type=checkbox][data-k]")) {
        const k = input.getAttribute("data-k");
        input.checked = !!saved[k];
        input.addEventListener("change", () => {
          saved[k] = input.checked;
          localStorage.setItem(storageKey, JSON.stringify(saved));
          input.closest(".check")?.classList.toggle("check--done", input.checked);
        });
        input.closest(".check")?.classList.toggle("check--done", input.checked);
      }

      const clearBtn = document.getElementById("clearChecks");
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          localStorage.removeItem(storageKey);
          for (const input of wrap.querySelectorAll("input[type=checkbox][data-k]")) {
            input.checked = false;
            input.closest(".check")?.classList.remove("check--done");
          }
        });
      }
    })();
  </script>
  {% if job and job.status == "done" %}
  <script>
    (function () {
      const pieEl = document.getElementById("secPie");
      const secModalEl = document.getElementById("secModal");
      let securityData = null;

      function renderSecurity(data) {
        const missingEl = document.getElementById("missingHeaders");
          const insecureEl = document.getElementById("insecureAssets");
          const originsEl = document.getElementById("assetOrigins");
          const passedEl = document.getElementById("passedHeaders");
          const cssCount = document.getElementById("cssCount");
          const jsCount = document.getElementById("jsCount");
          const imgCount = document.getElementById("imgCount");
        const secAlert = document.getElementById("secAlert");
        const secError = document.getElementById("secError");

        if (!data || data.error) {
          if (secError) {
            secError.classList.remove("d-none");
            secError.textContent = "Güvenlik kontrolü başarısız: " + (data?.error || "bilinmiyor");
          }
          if (secAlert) {
            secAlert.classList.remove("d-none");
            secAlert.textContent = "HSTS/başlık raporu alınamadı. URL erişilebilir mi kontrol edin.";
          }
          return;
        }

        const missing = data.missing_headers || [];
        const totalHeaders = {{ SECURITY_HEADERS|length if SECURITY_HEADERS is defined else 6 }};
        const present = totalHeaders - missing.length;
        const insecureAssets = data.insecure_assets || [];
        const headerNames = {{ SECURITY_HEADERS|tojson if SECURITY_HEADERS is defined else "[]" }};

        if (pieEl) {
          new Chart(pieEl, {
            type: "pie",
            data: {
              labels: ["Mevcut", "Eksik"],
              datasets: [
                {
                  data: [Math.max(0, present), Math.max(0, missing.length)],
                  backgroundColor: ["#16a34a", "#ef4444"],
                },
              ],
            },
            options: { plugins: { legend: { position: "bottom" } } },
          });
        }

        if (missingEl) {
          missingEl.innerHTML = "";
          if (!missing.length) {
            missingEl.innerHTML = '<li class="list-group-item text-success">Eksik başlık yok.</li>';
          } else {
            missingEl.innerHTML = missing
              .map(
                (h) =>
                  `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${h}</span><span class="badge text-bg-danger">eksik</span></li>`,
              )
              .join("");
          }
        }

        if (insecureEl) {
          insecureEl.innerHTML = "";
          if (!insecureAssets.length) {
            insecureEl.innerHTML = '<li class="list-group-item text-success">Tüm assetler https.</li>';
          } else {
            insecureAssets.slice(0, 50).forEach((a) => {
              const li = document.createElement("li");
              li.className = "list-group-item small";
              if (a.startsWith("http")) {
                li.innerHTML = `<a href="${a}" target="_blank" rel="noreferrer">${a}</a>`;
              } else {
                li.textContent = a;
              }
              insecureEl.appendChild(li);
            });
            if (insecureAssets.length > 50) {
              const li = document.createElement("li");
              li.className = "list-group-item text-muted";
              li.textContent = `+${insecureAssets.length - 50} daha...`;
              insecureEl.appendChild(li);
            }
          }
        }

        if (passedEl) {
          passedEl.innerHTML = "";
          const presentList = headerNames.filter((h) => !missing.includes(h));
          if (!presentList.length) {
            passedEl.innerHTML = '<li class="list-group-item text-muted">Geçen başlık yok.</li>';
          } else {
            presentList.forEach((h) => {
              const li = document.createElement("li");
              li.className = "list-group-item d-flex align-items-center gap-2 text-success";
              li.innerHTML = `<i class="fa fa-check-circle"></i><span>${h}</span>`;
              passedEl.appendChild(li);
            });
          }
        }

        if (originsEl) {
          originsEl.innerHTML = "";
          const origins = data.asset_origins || {};
          const external = origins.external || [];
          const internal = origins.internal || [];
          if (!external.length) {
            originsEl.innerHTML = '<li class="list-group-item text-success">Harici asset kaynağı yok.</li>';
          } else {
            external.slice(0, 50).forEach((o) => {
              const li = document.createElement("li");
              li.className = "list-group-item d-flex justify-content-between align-items-start";
              const types = (o.types || []).join(", ");
              li.innerHTML = `<div><div class="fw-semibold">${o.host}</div><small class="text-muted">${types}</small></div><span class="badge text-bg-warning">${o.count}</span>`;
              originsEl.appendChild(li);
            });
            if (external.length > 50) {
              const li = document.createElement("li");
              li.className = "list-group-item text-muted";
              li.textContent = `+${external.length - 50} daha...`;
              originsEl.appendChild(li);
            }
          }
          if (internal.length) {
            const sep = document.createElement("li");
            sep.className = "list-group-item text-muted";
            sep.textContent = "İç (geçen) kaynaklar";
            originsEl.appendChild(sep);
            internal.slice(0, 50).forEach((o) => {
              const li = document.createElement("li");
              li.className = "list-group-item d-flex justify-content-between align-items-start";
              const types = (o.types || []).join(", ");
              li.innerHTML = `<div><div class="fw-semibold">${o.host}</div><small class="text-muted">${types}</small></div><span class="badge text-bg-success">${o.count}</span>`;
              originsEl.appendChild(li);
            });
          }
        }

        if (cssCount) cssCount.textContent = `${(data.assets?.css || []).length} CSS linki`;
        if (jsCount) jsCount.textContent = `${(data.assets?.js || []).length} JS dosyası`;
        if (imgCount) imgCount.textContent = `${(data.assets?.img || []).length} görsel`;

        if (secAlert) secAlert.classList.add("d-none");
        if (secError) secError.classList.add("d-none");
      }

      function fetchSecurity() {
        return fetch("/security/{{ job_id }}/report")
          .then((r) => r.json())
          .then((data) => {
            console.log("SECURITY_REPORT", data);
            securityData = data;
            renderSecurity(data);
          })
          .catch((err) => {
            const secError = document.getElementById("secError");
            const secAlert = document.getElementById("secAlert");
            if (secError) {
              secError.classList.remove("d-none");
              secError.textContent = "Güvenlik kontrolü başarısız: " + err;
            }
            if (secAlert) {
              secAlert.classList.remove("d-none");
              secAlert.textContent = "HSTS/başlık raporu alınamadı. URL erişilebilir mi kontrol edin.";
            }
          });
      }

      // Fetch once after DOM ready (script is already at page bottom)
      fetchSecurity();

      // Re-render when modal opens (in case DOM rebuilt)
      if (secModalEl) {
        secModalEl.addEventListener("show.bs.modal", () => {
          if (securityData) {
            renderSecurity(securityData);
          } else {
            fetchSecurity();
          }
        });
      }

      // Coverage detail modal
      const coverageBtns = document.querySelectorAll("[data-coverage-detail]");
      const covModalEl = document.getElementById("coverageModal");
      const covTitle = document.getElementById("coverageTitle");
      const covBody = document.getElementById("coverageBody");
      let covModal;
      if (covModalEl) {
        covModal = new bootstrap.Modal(covModalEl);
      }
      coverageBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = btn.getAttribute("data-coverage-detail") || "";
          const heading = btn.textContent?.trim() || "Detay";
          if (covTitle) covTitle.textContent = heading;
          if (covBody) {
            covBody.innerHTML = text.replace(/\\n/g, "<br>");
          }
          if (covModal) covModal.show();
        });
      });
    })();
  </script>
  {% endif %}
{% endblock %}

{% block extra_modals %}
<div class="modal fade" id="secModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Güvenlik Başlıkları ve Asset Kontrolü</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div id="secAlert" class="alert alert-info py-2 d-none"></div>
          <div id="secError" class="alert alert-danger py-2 d-none"></div>
          <div class="mb-3">
            <h6>Eksik Başlıklar</h6>
            <ul class="list-group" id="missingHeaders"></ul>
          </div>
          <div class="mb-3">
            <h6>Geçen Başlıklar</h6>
            <ul class="list-group" id="passedHeaders"></ul>
          </div>
          <div class="mb-3">
            <h6>Güvenli olmayan assetler (http://)</h6>
            <ul class="list-group" id="insecureAssets"></ul>
          </div>
          <div class="mb-3">
            <h6>Harici asset kaynakları (permissions-policy için kaynaklar)</h6>
            <ul class="list-group" id="assetOrigins"></ul>
          </div>
          <div class="mb-3">
            <h6>Toplanan linkler</h6>
            <div class="row g-2">
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="fw-semibold mb-1">CSS</div>
                    <small id="cssCount" class="text-muted"></small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="fw-semibold mb-1">JS</div>
                    <small id="jsCount" class="text-muted"></small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="fw-semibold mb-1">IMG</div>
                    <small id="imgCount" class="text-muted"></small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="coverageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="coverageTitle">Detay</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body" id="coverageBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
